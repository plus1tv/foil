#!/usr/bin/env node
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("chalk"),require("process"),require("path"),require("fs"),require("find"),require("glob-to-regexp"),require("dependency-tree"),require("mongodb"),require("webpack"),require("child_process"),require("markademic"),require("rss")):"function"==typeof define&&define.amd?define(["exports","chalk","process","path","fs","find","glob-to-regexp","dependency-tree","mongodb","webpack","child_process","markademic","rss"],t):t((e||self).foilCli={},e.chalk,e.process,e.path,e.fs,e.find,e.globToRegexp,e.dependencyTree,e.mongodb,e.webpack,e.childProcess,e.markademic,e.rss)}(this,function(e,t,o,n,r,i,l,a,s,c,d,f,u){function m(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var g=/*#__PURE__*/m(n),p=/*#__PURE__*/m(r),h=/*#__PURE__*/m(i),y=/*#__PURE__*/m(l),w=/*#__PURE__*/m(c),b=/*#__PURE__*/m(f),k=/*#__PURE__*/m(u);let v=process.env.NODE_ENV,x=v&&v.match(/production/)||o.argv.reduce((e,t)=>e||"--production"===t,!1),j=o.argv.reduce((e,t)=>e||"--watch"===t,!1);function P(){return(P=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var o=arguments[t];for(var n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n])}return e}).apply(this,arguments)}let S={author:{name:"Alain Galvan",email:"hi@alain.xyz",url:"https://alain.xyz/libraries/foil"},tags:["programming"],cover:"",description:"",files:["assets/*"],redirects:[],currentDir:n.resolve("."),foilCliRoot:n.resolve(n.join(__dirname,".."))},D=n.join(n.resolve("."),"foil.json");if(r.existsSync(D)){console.log("‚öôÔ∏è Found foil.json file.");let e=require(D);S=P({},S,e),n.isAbsolute(S.currentDir)||(S.currentDir=n.join(n.resolve("."),S.currentDir))}console.log("üçÉ Opening MongoDB Connection.");const $=s.MongoClient.connect("mongodb://localhost:27017").catch(e=>console.error(e));function T(){$.then(async e=>{console.log("üçÉ Closing MongoDB Connection."),e.close(),process.exit()})}function _(e,t,o="cover"){let n=g.default.dirname(e),r=h.default.fileSync(new RegExp(o+".(png|jpg|jpeg|gif)$","mg"),n);return r.length>0?g.default.join(t,g.default.relative(n,r[0])).replace(/\\/g,"/"):""}async function q(e){var t=await new Promise((t,o)=>{$.then(async n=>{n.db("db").collection("portfolio").find({"meta.rootPath":e}).toArray().then(e=>t(e)).catch(e=>o(e))}).catch(e=>console.error(e))});return t.length<1?[]:t[0].meta.files}async function A(e){await $.then(async o=>{let n=o.db("db");var r=n.collection("redirect");let i=["tsx","ts","scss","md","json","lock","db"];var l=h.default.fileSync(e.meta.rootPath).filter(e=>!(i.reduce((t,o)=>t||e.endsWith(o),!1)||e.match(/node_modules|diary/)));for(var a of l){let t={to:a},o={from:g.default.join(e.rootPermalink,g.default.relative(e.meta.rootPath,a)).replace(/\\/g,"/"),to:a,dateModified:p.default.statSync(a).mtime},n={upsert:!0};await r.updateOne(t,{$set:o},n).then(e=>{}).catch(e=>console.log(e))}l.length>0&&console.log(t.gray(`üìí Indexed ${l.length} static file${1==l.length?"":"s"}.`));var s=n.collection("portfolio");await s.updateOne({permalink:e.permalink},{$set:e},{upsert:!0}).then(o=>console.log(`Added ${t.cyan(e.title)} to the Database.`)).catch(e=>console.log(e))})}function O(e){let{description:t,author:o=S.author,contributors:l=[],keywords:s=[],main:c,files:d=[],foil:f}=require(e);if(!f)return null;let u=[],m=e=>{let t={name:"",email:"",url:""};if("string"==typeof e){let o=/[\w\s]*(?![\<\(])/.exec(e);o&&(t.name=o[0]);let n=/(?!\<)\w*(?=\>)/.exec(e);n&&(t.email=n[0]);let r=/(?!\()\w*(?=\))/.exec(e);r&&(t.url=r[0])}return t.name=e.name,t.email=e.email,t.url=e.url,t};if(l.length<=0)u.push(m(o));else for(let e of l)u.push(m(e));let g=n.join(e,".."),{permalink:p}=f;if(!p)return console.warn("Foil package has no permalink! Foilfolio needs a permalink to resolve routes!"),null;if("/"==p.charAt(0))return console.warn("Foil package has an invalid permalink. Permalinks cannot start with /"),null;p="/"+p;let h=p;/\*$/.exec(p)&&(h=p.replace(/\*$/,""));let{datePublished:w=(new Date).toISOString(),cover:b=_(e,h),icon:k=_(e,h,"icon")}=f,v=new Set;if(v.add(e),c&&(v.add(c),c.match(/\.(t|j)sx?$/))){let e=c;n.isAbsolute(e)||(e=n.join(g,e)),r.existsSync(e)&&a.toList({filename:e,directory:g,filter:e=>-1===e.indexOf("node_modules"),nodeModulesConfig:{entry:"module"},tsConfig:{compilerOptions:{target:"es2016",module:"CommonJS",isolatedModules:!0,allowSyntheticDefaultImports:!0,noImplicitAny:!1,suppressImplicitAnyIndexErrors:!0,removeComments:!0,jsx:"react"},transpileOnly:!0}}).forEach(e=>v.add(e))}for(let e of d)if(null===/\*/.exec(e))v.add(e);else{let t=i.fileSync(y.default(e),S.currentDir);for(let e of t)v.add(e)}let x=function(e,t,o=[]){for(let i of t){n.isAbsolute(i)||(i=n.join(e,i)),i.replace(/\\/g,"/");let t={path:i,modified:new Date};r.existsSync(i)&&(t.modified=r.statSync(i).mtime,r.statSync(i).isDirectory()||o.push(t))}return[...o]}(g,Array.from(v)),j=x.reduce((e,t)=>e.modified>t.modified?e:t,{modified:new Date("1970-01-01Z00:00:00:000")}).modified,{publicDateModifiedFiles:D=[".md$"]}=f,$=new Date("1970-01-01Z00:00:00:000");if(D.length>0)for(let e of x)D.reduce((t,o)=>t||new RegExp(o).test(e.path),!1)&&$<e.modified&&($=e.modified);$<=new Date("1970-01-02Z00:00:00:000")&&($=j);let T=new Date(w);return NaN===T.getDate()&&(console.warn("üìÖ Provided publish date is invalid, replacing with today: "+w),T=new Date),P({},f,{description:t,authors:u,keywords:s,permalink:p,rootPermalink:h,datePublished:T,dateModified:$,cover:b,icon:k,main:c,meta:{files:x,dateModified:j,rootPath:g}})}async function C(){let e=[],t=i.fileSync(/\package.json$/,S.currentDir);for(var o of(t=t.filter(e=>!e.match(/node_modules/)),t)){let t=O(o);if(t){let o=!1;var n=await q(t.meta.rootPath);if(o=o||n.length<=0||n.length!==t.meta.files.length,!o){for(let e of n)if(r.existsSync(e.path)&&(o=o||r.statSync(e.path).mtime.getTime()!==e.modified.getTime(),o))break;if(!o)for(let e of t.meta.files){let t=!1;for(let o of n)if(t=t||e.path==o.path,t)break;o=o||!t}}o&&e.push(t)}}return e}async function F(e){return!r.existsSync(e)||await $.then(async t=>{let o=t.db("db"),n=o.collection("portfolio"),i=await n.find({"meta.files.path":e}).project({"meta.files":1}).limit(1).toArray();if("object"==typeof i&&i.length>=1){var{mtime:l}=r.statSync(e);for(let t of i[0].meta.files)if(t.path===e)return l.getDate()===new Date(t.modified).getDate()}let a=o.collection("redirect"),s=await a.find({to:e}).limit(1).toArray();if("object"==typeof s&&s.length>=1){var{mtime:l}=r.statSync(e);return l.getDate()===new Date(s[0].dateModified).getDate()}return!0})}process.on("SIGTERM",T).on("SIGINT",T);const R=x?"production":"development",E=["react","react/jsx-runtime","react-dom","react-router-dom","redux","react-redux","main"];let M=[{test:{main:/\.tsx?$/},transform:async e=>{let o=e.main;n.isAbsolute(e.main)||(o=n.join(e.meta.rootPath,e.main)),o.replace(/\\/g,"/");let i=o.replace(/\.tsx?$/,".js").replace(/\\/g,"/"),l=n.join(e.rootPermalink,e.main).replace(/\.tsx?$/,".js").replace(/\\/g,"/");if(await F(o)){console.log("üü¶ TypeScript Transformer:");let{dependencies:a,devDependencies:s}=require(n.join(e.meta.rootPath,"package.json"));return(a||s)&&await function(e){return new Promise((t,o)=>{d.exec("npm i",{cwd:e},(n,r,i)=>{console.log("üì¶ Installing dependencies via NPM.",e),n?o(n):t(r)})})}(e.meta.rootPath),await function(e,o,r,i){let l={mode:R,context:n.resolve(e),entry:{main:"./main"},output:{path:n.resolve(e),filename:"main.js",libraryTarget:"system",library:{type:"system"}},resolve:{extensions:[".ts",".tsx",".js"],modules:[e,n.join(e,"node_modules"),n.join(S.currentDir,"node_modules"),n.join(S.foilCliRoot,"..","node_modules"),"node_modules"],fallback:{crypto:!1,fs:!1,path:require.resolve("path-browserify")}},resolveLoader:{modules:[e,n.join(e,"node_modules"),n.join(S.currentDir,"node_modules"),n.join(S.foilCliRoot,"..","node_modules"),"node_modules"]},module:{rules:[{test:/\.tsx?$/,exclude:/node_modules/,loader:"ts-loader",options:{transpileOnly:!0,compilerOptions:{module:"esnext",sourceMap:!x}}},{test:/\.wasm$/,loader:"file-loader",options:{name:"[name].[ext]",publicPath:i}},{test:/\.(wgsl|glsl)$/,type:"asset/source"}]},node:!1,externalsType:"system",externals:E,externalsPresets:{web:!0},plugins:[new w.default.DefinePlugin({"process.env":{NODE_ENV:JSON.stringify(R)}})],devtool:x?void 0:"inline-source-map",optimization:{minimize:!!x}};console.log(`üî® Building Module '${t.cyan(r)}'`);var a=w.default(l);return new Promise((e,t)=>a.run((o,n)=>{o?t(o):e(n)})).then(e=>{e.compilation.errors.length>0&&console.log(t.yellow(`Build Succeeded with ${e.compilation.errors.length} errors.\n`+e.compilation.errors.reduce((e,t)=>"object"==typeof t?e+t.message+"\n":e+t+"\n","\n"))),console.log("üü® Done in %s ms!\n",+e.endTime-+e.startTime)}).catch(e=>console.error(e))}(n.join(i,".."),0,l,e.rootPermalink),await function(e,o,n){return $.then(i=>{var l=i.db("db").collection("redirect");let a={from:o},s={from:o,to:e,dateModified:r.statSync(n).mtime};l.updateOne(a,{$set:s},{upsert:!0}),console.log(t.gray(`üìí Indexed ${t.yellow(o)}`))})}(i,l,o),P({},e,{main:l})}return e}},{test:{permalink:/^\/(blog|research|libraries|notes)/},transform:async e=>{let o=null;for(let t of e.meta.files)/\.md$/.exec(t.path)&&(o=t);if(!o)return e;if(F(o)){console.log("üìù Blog Transformer:");var i={input:r.readFileSync(o.path).toString(),rerouteLinks:t=>n.join(e.rootPermalink,t)};let f=n.join(e.meta.rootPath,"bib.json");r.existsSync(f)&&(i.citations=require(f));var l=b.default(i);console.log("üè´ Built "+t.yellow(n.basename(o.path))+" with Markademic.");var a=null;for(let t of e.meta.files)/\.mp3$/.exec(t.path)&&(a=t.path.substr(e.meta.rootPath.length).replace(/\\/g,"/"));var s=[],c=n.join(e.meta.rootPath,"captions.json");r.existsSync(c)&&(s=require(c).captions,Array.isArray(s)&&(s=[]));var d={article:l,audio:{file:a,captions:s}};return"object"==typeof e.data&&(d=P({},e.data,{article:l})),P({},e,{data:d})}return e}},{test:{permalink:/^\/books\/|docs/},transform:async e=>{console.log("üìö Book Transformer: \n");let t=[],o=[],i=null;for(let t of e.meta.files)if(null!=/(summary)|(toc)|(table-of-contents)/i.exec(t.path)){i=t;break}if(!i)throw new Error("Foil book is missing a Table of Contents! Create a file called `toc.md` in the root directory of this entry.");let l=r.readFileSync(i.path).toString(),a=/(\n\s*(\-|\+|\*)\s.*)+/g.exec(l);if(!a)throw new Error("Table of contents is missing an unordered list of links. This is needed to build navigation data structures and traverse the book.");l=l.substr(a.index,l.length);let s=t,c=/\[([^\[]+)\]\(([^\)]+)\)/g,d=c.exec(l);for(;null!=d;)s.push({text:d[1],link:d[2],children:[]}),d=c.exec(l);for(let i of t){let t=/\.[^/.]+$/.exec(i.link),l=/(\/|\\)$/.exec(i.link),a=n.join(e.meta.rootPath,i.link);t&&(i.link=i.link.replace(/\.[^/.]+$/,"")),l&&(i.link=i.link.substr(0,i.link.length-1),a+="index.md"),i.link=n.join("/",e.rootPermalink,i.link).replace(/\\/gi,"/"),console.log(i.link),console.log(a),t||l||(a+=".md");let s=null,c=n.join(e.meta.rootPath,"bib.json"),d=n.join(a,t?"..":"","bib.json");if(r.existsSync(c)&&(s=require(c)),r.existsSync(d)){let e=require(d);s=s?P({},s,e):e}if(r.existsSync(a)){var f={input:r.readFileSync(a).toString(),rerouteLinks:t=>n.join(e.rootPermalink,t)};s&&(f.citations=s);var u=b.default(f);o.push(u)}}return P({},e,{data:{toc:t,chapters:o}})}}];function I(e,t){return Object.keys(e.test).reduce((o,n)=>{let r=new RegExp(e.test[n]);return o||r.test(t[n])},!1)}async function N(e,t){for(let o of e)if(I(o,t))try{t=await o.transform(t)}catch(e){console.error(e)}return t}var W,z=[async function(e){console.log("üåä Foil Database Cleaner:"),await $.then(async e=>{let o=e.db("db");var i=o.collection("redirect"),l=o.collection("portfolio"),a=e=>e.find({}).toArray().catch(e=>console.error(e)).then(t=>{if(t)for(var o of t){let{_id:t,permalink:i=null}=o,l=o.to?[{path:o.to}]:o.meta.files;for(let o of l){let l=()=>{e.deleteOne({_id:t}).catch(e=>console.error(e)).then(()=>console.log("‚ùå Removed "+o.path))};/\.([A-z])*$/.test(o.path)&&r.stat(o.path,e=>{if("ENOENT"===(null==e?void 0:e.code)&&l(),e&&"package.json"==n.basename(o.path)&&i){let e=require(o.path);e.foil&&"/"+e.foil.permalink!==i&&(console.log("Permalink "+i+" does not match "+e.foil.permalink+", deleting."),l())}})}}});await a(i),console.log(`üßº Cleaned ${t.cyan("'files'")} collection.`),await a(l),console.log(`üßº Cleaned ${t.cyan("'portfolio'")} collection.`)})},async function(e){for(var o of(console.log("üì¶ Foil Database Builder:"),e))if(o){console.log("‚ö™ Processing "+t.yellow(`'${o.permalink}'`)+":");let e=await N(M,o);await A(e)}},async function(e){console.log("üìª Foil RSS Feeds \n");let t={title:"Alain.xyz",description:S.description,feed_url:S.author.url+"/rss",site_url:S.author.url,image_url:S.cover,managingEditor:S.author.name,webMaster:S.author.name,copyright:"Copyright "+S.author.name+" All Rights Reserved.",language:"English",categories:S.tags,pubDate:new Date,ttl:1200},o=new k.default(t),i=await new Promise((e,t)=>$.then(t=>{t.db("db").collection("portfolio").find({datePublished:{$lte:new Date},permalink:new RegExp("/blog/w*")}).limit(30).sort({datePublished:-1}).toArray((t,o)=>{if(t||0===o.length)return e([]);e(o)})}));for(var l of i){let e=await new Promise((e,t)=>$.then(t=>{t.db("db").collection("redirect").find({from:l.cover}).limit(1).toArray((t,o)=>{if(t||0===o.length)return e(null);e(o)})}));var a=0;e&&(a=r.statSync(e[0].to).size),o.item({title:l.title,description:l.description,url:S.author.url+l.permalink,date:l.datePublished,enclosure:{url:S.author.url+l.cover,size:a}})}let s=o.xml(),c=n.join(S.currentDir,"rss.xml");try{r.writeFileSync(c,s),console.log("RSS feed successfully generated. \n Written to "+c+"\n")}catch(e){console.error("Could not generate RSS Feeds! \n")}},async function(e){console.log("üèπ Foil Database Redirects\n"),await $.then(async e=>{var t=e.db("db").collection("redirect"),o=S.redirects;for(var n of o)if(n.to&&n.from){let e={from:n.from},o={upsert:!0};await t.updateOne(e,{$set:{to:n.to,from:n.from}},o).then(e=>console.log(`Redirecting ${n.from} to ${n.to}.`)).catch(e=>console.log(e))}console.log("‚ú® Cleaned portfolio collection.")})}];class B{async run(e){for(var o=Object.values(z),n=0;n<o.length;n++){let r=`(${n+1}/${o.length})`;console.log(`\nüëü ${t.gray(` Running Task ${r}...`)}`),await o[n](e).then(e=>{console.log(`‚úîÔ∏èÔ∏è ${t.green(` Finished Task ${r}!`)}`)}).catch(e=>{console.log(`\n‚ùå ${t.red(` Failed Task ${r}!`)}`),console.error(e)})}console.log("\nüíÆ "+t.gray(` Finished processing ${o.length} tasks!\n`))}}!function(e){e[e.Initial=0]="Initial",e[e.Watching=1]="Watching",e[e.Processing=2]="Processing",e[e.Done=3]="Done"}(W||(W={}));class L{constructor(){this.watch=async e=>{let o=W.Initial;const n=new B;let r=[];const i=async()=>{switch(+o){case W.Initial:e.length>0&&await n.run(e),console.log(t.gray("\nüëÄ  ¬∑ Watching for changes... ¬∑ \n")),o=W.Watching;break;case W.Watching:r=await C(),r.length>0&&(o=W.Processing);break;case W.Processing:r.length>0&&await n.run(r),o=W.Done;break;case W.Done:console.log(t.gray("\nüëÄ  ¬∑ Watching for changes... ¬∑ \n")),o=W.Watching}await i()};await i()}}}async function G(){console.log("üëã Hi "+S.author.name+"!");let e=await C();if(e.length>0&&console.log(t.gray("üé° Processing "+e.length+" files.")),j){const t=new L;await t.watch(e)}else if(e.length>0){const t=new B;await t.run(e)}else console.log(t.gray("üëç No changes found, exiting."));return process.exit()}console.log(t.cyan("‚ú® Foil v1.0.0-alpha.0")+t.gray(x?" (production)":" (development)")),G(),e.foil=G});
//# sourceMappingURL=foil-cli.umd.js.map
