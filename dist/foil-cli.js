#!/usr/bin/env node
var e=require("chalk"),t=require("process"),o=require("path"),n=require("fs"),r=require("find"),i=require("glob-to-regexp"),a=require("dependency-tree"),l=require("mongodb"),s=require("webpack"),c=require("child_process"),d=require("markademic"),m=require("feed");function u(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var f=/*#__PURE__*/u(i);let g=process.env.NODE_ENV,h=g&&g.match(/production/)||t.argv.reduce((e,t)=>e||"--production"===t,!1),p=t.argv.reduce((e,t)=>e||"--watch"===t,!1);function y(){return(y=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var o=arguments[t];for(var n in o)Object.prototype.hasOwnProperty.call(o,n)&&(e[n]=o[n])}return e}).apply(this,arguments)}let w={title:"Alain.xyz",author:{name:"Alain Galvan",email:"hi@alain.xyz",url:"https://alain.xyz/libraries/foil"},tags:["programming"],cover:"",description:"",files:["assets/*"],redirects:[],currentDir:o.resolve("."),foilCliRoot:o.resolve(o.join(__dirname)),mongoUrl:"mongodb://127.0.0.1:27017"},b=o.join(o.resolve("."),"foil.json");if(n.existsSync(b)){console.log("⚙️ Found foil.json file.");let e=require(b);w=y({},w,e),o.isAbsolute(w.currentDir)||(w.currentDir=o.join(o.resolve("."),w.currentDir))}console.log("🍃 Opening MongoDB Connection. "+e.gray("("+w.mongoUrl+")"));const k=l.MongoClient.connect(w.mongoUrl,{appName:"Foil Backend"}).catch(e=>console.error(e));function v(){k.then(async e=>{console.log("🍃 Closing MongoDB Connection."),e.close(),process.exit()})}function x(e,t,n="cover"){let i=o.dirname(e),a=r.fileSync(new RegExp(n+".(png|jpg|jpeg|gif)$","mg"),i);return a.length>0?o.join(t,o.relative(i,a[0])).replace(/\\/g,"/"):""}async function j(e){var t=await new Promise((t,o)=>{k.then(async n=>{n.db("db").collection("portfolio").find({"meta.rootPath":e}).toArray().then(e=>t(e)).catch(e=>o(e))}).catch(e=>console.error(e))});return t.length<1?[]:t[0].meta.files}async function S(t){await k.then(async i=>{let a=i.db("db");var l=a.collection("redirect");let s=["tsx","ts","scss","md","json","lock","db"];var c=r.fileSync(t.meta.rootPath).filter(e=>!(s.reduce((t,o)=>t||e.endsWith(o),!1)||e.match(/node_modules|diary/)));for(var d of c){let e={to:d},r={from:o.join(t.rootPermalink,o.relative(t.meta.rootPath,d)).replace(/\\/g,"/"),to:d,dateModified:n.statSync(d).mtime},i={upsert:!0};await l.updateOne(e,{$set:r},i).then(e=>{}).catch(e=>console.log(e))}c.length>0&&console.log(e.gray(`📒 Indexed ${c.length} static file${1==c.length?"":"s"}.`));var m=a.collection("portfolio");await m.updateOne({permalink:t.permalink},{$set:t},{upsert:!0}).then(o=>console.log(`Added ${e.cyan(t.title)} to the Database.`)).catch(e=>console.log(e))})}function D(e){let{description:t,author:i=w.author,contributors:l=[],keywords:s=[],main:c,files:d=[],foil:m}=require(e);if(!m)return null;let u=[],g=e=>{let t={name:"",email:"",url:""};if("string"==typeof e){let o=/[\w\s]*(?![\<\(])/.exec(e);o&&(t.name=o[0]);let n=/(?!\<)\w*(?=\>)/.exec(e);n&&(t.email=n[0]);let r=/(?!\()\w*(?=\))/.exec(e);r&&(t.url=r[0])}return t.name=e.name,t.email=e.email,t.url=e.url,t};if(l.length<=0)u.push(g(i));else for(let e of l)u.push(g(e));let h=o.join(e,".."),{permalink:p}=m;if(!p)return console.warn("Foil package has no permalink! Foilfolio needs a permalink to resolve routes!"),null;if("/"==p.charAt(0))return console.warn("Foil package has an invalid permalink. Permalinks cannot start with /"),null;p="/"+p;let b=p;/\*$/.exec(p)&&(b=p.replace(/\*$/,""));let{datePublished:k=(new Date).toISOString(),cover:v=x(e,b),icon:j=x(e,b,"icon")}=m,S=new Set;if(S.add(e),c&&(S.add(c),c.match(/\.(t|j)sx?$/))){let e=c;o.isAbsolute(e)||(e=o.join(h,e)),n.existsSync(e)&&a.toList({filename:e,directory:h,filter:e=>-1===e.indexOf("node_modules"),nodeModulesConfig:{entry:"module"},tsConfig:{compilerOptions:{target:"es2016",module:"CommonJS",isolatedModules:!0,allowSyntheticDefaultImports:!0,noImplicitAny:!1,suppressImplicitAnyIndexErrors:!0,removeComments:!0,jsx:"react"},transpileOnly:!0}}).forEach(e=>S.add(e))}for(let e of d)if(null===/\*/.exec(e))S.add(e);else{let t=r.fileSync(f.default(e),w.currentDir);for(let e of t)S.add(e)}let D=function(e,t,r=[]){for(let i of t){o.isAbsolute(i)||(i=o.join(e,i)),i.replace(/\\/g,"/");let t={path:i,modified:new Date};n.existsSync(i)&&(t.modified=n.statSync(i).mtime,n.statSync(i).isDirectory()||r.push(t))}return[...r]}(h,Array.from(S)),P=D.reduce((e,t)=>e.modified>t.modified?e:t,{modified:new Date("1970-01-01Z00:00:00:000")}).modified,{publicDateModifiedFiles:$=[".md$"]}=m,F=new Date("1970-01-01Z00:00:00:000");if($.length>0)for(let e of D)$.reduce((t,o)=>t||new RegExp(o).test(e.path),!1)&&F<e.modified&&(F=e.modified);F<=new Date("1970-01-02Z00:00:00:000")&&(F=P);let A=new Date(k);return NaN===A.getDate()&&(console.warn("📅 Provided publish date is invalid, replacing with today: "+k),A=new Date),y({},m,{description:t,authors:u,keywords:s,permalink:p,rootPermalink:b,datePublished:A,dateModified:F,cover:v,icon:j,main:c,meta:{files:D,dateModified:P,rootPath:h}})}async function P(){let e=[],t=r.fileSync(/\package.json$/,w.currentDir);for(var o of(t=t.filter(e=>!e.match(/node_modules/)),t)){let t=D(o);if(t){let o=!1;var i=await j(t.meta.rootPath);if(o=o||i.length<=0||i.length!==t.meta.files.length,!o){for(let e of i)if(n.existsSync(e.path)&&(o=o||n.statSync(e.path).mtime.getTime()!==e.modified.getTime(),o))break;if(!o)for(let e of t.meta.files){let t=!1;for(let o of i)if(t=t||e.path==o.path,t)break;o=o||!t}}o&&e.push(t)}}return e}async function $(e){return!n.existsSync(e)||await k.then(async t=>{let o=t.db("db"),r=o.collection("portfolio"),i=await r.find({"meta.files.path":e}).project({"meta.files":1}).limit(1).toArray();if("object"==typeof i&&i.length>=1){var{mtime:a}=n.statSync(e);for(let t of i[0].meta.files)if(t.path===e)return a.getDate()===new Date(t.modified).getDate()}let l=o.collection("redirect"),s=await l.find({to:e}).limit(1).toArray();if("object"==typeof s&&s.length>=1){var{mtime:a}=n.statSync(e);return a.getDate()===new Date(s[0].dateModified).getDate()}return!0})}process.on("SIGTERM",v).on("SIGINT",v);const F=h?"production":"development",A=["react","react/jsx-runtime","react-dom","react-router-dom","redux","react-redux","main"];let q=[{test:{main:/\.tsx?$/},transform:async t=>{let r=t.main;o.isAbsolute(t.main)||(r=o.join(t.meta.rootPath,t.main)),r.replace(/\\/g,"/");let i=r.replace(/\.tsx?$/,".js").replace(/\\/g,"/"),a=o.join(t.rootPermalink,t.main).replace(/\.tsx?$/,".js").replace(/\\/g,"/");if(await $(r)){console.log("🟦 TypeScript Transformer:");let{dependencies:l,devDependencies:d}=require(o.join(t.meta.rootPath,"package.json"));return(l||d)&&await function(e){return new Promise((t,o)=>{c.exec("npm i",{cwd:e},(n,r,i)=>{console.log("📦 Installing dependencies via NPM.",e),n?o(n):t(r)})})}(t.meta.rootPath),await function(t,n,r,i){let a={mode:F,context:o.resolve(t),entry:{main:"./main"},output:{path:o.resolve(t),filename:"main.js",libraryTarget:"system",library:{type:"system"}},resolve:{extensions:[".ts",".tsx",".js"],modules:[t,o.join(t,"node_modules"),o.join(w.currentDir,"node_modules"),o.join(w.foilCliRoot,"..","node_modules"),"node_modules"],fallback:{crypto:!1,fs:!1,path:require.resolve("path-browserify")}},resolveLoader:{modules:[t,o.join(t,"node_modules"),o.join(w.currentDir,"node_modules"),o.join(w.foilCliRoot,"..","node_modules"),"node_modules"]},module:{rules:[{test:/\.tsx?$/,exclude:/node_modules/,loader:"ts-loader",options:{transpileOnly:!0,compilerOptions:{module:"esnext",sourceMap:!h}}},{test:/\.wasm$/,loader:"file-loader",options:{name:"[name].[ext]",publicPath:i}},{test:/\.(wgsl|glsl)$/,type:"asset/source"}]},node:!1,externalsType:"system",externals:A,externalsPresets:{web:!0},plugins:[new s.DefinePlugin({"process.env":{NODE_ENV:JSON.stringify(F)}})],devtool:h?void 0:"inline-source-map",optimization:{minimize:!!h}};console.log(`🔨 Building Module '${e.cyan(r)}'`);var l=s.webpack(a);return new Promise((e,t)=>l.run((o,n)=>{o?t(o):e(n)})).then(t=>{t.compilation.errors.length>0&&console.log(e.yellow(`Build Succeeded with ${t.compilation.errors.length} errors.\n`+t.compilation.errors.reduce((e,t)=>"object"==typeof t?e+t.message+"\n":e+t+"\n","\n"))),console.log("🟨 Done in %s ms!\n",+t.endTime-+t.startTime)}).catch(e=>console.error(e))}(o.join(i,".."),0,a,t.rootPermalink),await function(t,o,r){return k.then(i=>{var a=i.db("db").collection("redirect");let l={from:o},s={from:o,to:t,dateModified:n.statSync(r).mtime};a.updateOne(l,{$set:s},{upsert:!0}),console.log(e.gray(`📒 Indexed ${e.yellow(o)}`))})}(i,a,r),y({},t,{main:a})}return t}},{test:{permalink:/^\/(blog|research|libraries|notes)/},transform:async t=>{let r=null;for(let e of t.meta.files)/\.md$/.exec(e.path)&&(r=e);if(!r)return t;if($(r)){console.log("📝 Blog Transformer:");var i={input:n.readFileSync(r.path).toString(),rerouteLinks:e=>o.join(t.rootPermalink,e)};let u=o.join(t.meta.rootPath,"bib.json");n.existsSync(u)&&(i.citations=require(u));var a=d.markademic(i);console.log("🏫 Built "+e.yellow(o.basename(r.path))+" with Markademic.");var l=null;for(let e of t.meta.files)/\.mp3$/.exec(e.path)&&(l=e.path.substr(t.meta.rootPath.length).replace(/\\/g,"/"));var s=[],c=o.join(t.meta.rootPath,"captions.json");n.existsSync(c)&&(s=require(c).captions,Array.isArray(s)&&(s=[]));var m={article:a,audio:{file:l,captions:s}};return"object"==typeof t.data&&(m=y({},t.data,{article:a})),y({},t,{data:m})}return t}},{test:{permalink:/^\/books\/|docs/},transform:async e=>{console.log("📚 Book Transformer: \n");let t=[],r=[],i=null;for(let t of e.meta.files)if(null!=/(summary)|(toc)|(table-of-contents)/i.exec(t.path)){i=t;break}if(!i)throw new Error("Foil book is missing a Table of Contents! Create a file called `toc.md` in the root directory of this entry.");let a=n.readFileSync(i.path).toString(),l=/(\n\s*(\-|\+|\*)\s.*)+/g.exec(a);if(!l)throw new Error("Table of contents is missing an unordered list of links. This is needed to build navigation data structures and traverse the book.");a=a.substr(l.index,a.length);let s=t,c=/\[([^\[]+)\]\(([^\)]+)\)/g,m=c.exec(a);for(;null!=m;)s.push({text:m[1],link:m[2],children:[]}),m=c.exec(a);for(let i of t){let t=/\.[^/.]+$/.exec(i.link),a=/(\/|\\)$/.exec(i.link),l=o.join(e.meta.rootPath,i.link);t&&(i.link=i.link.replace(/\.[^/.]+$/,"")),a&&(i.link=i.link.substr(0,i.link.length-1),l+="index.md"),i.link=o.join("/",e.rootPermalink,i.link).replace(/\\/gi,"/"),console.log(i.link),console.log(l),t||a||(l+=".md");let s=null,c=o.join(e.meta.rootPath,"bib.json"),m=o.join(l,t?"..":"","bib.json");if(n.existsSync(c)&&(s=require(c)),n.existsSync(m)){let e=require(m);s=s?y({},s,e):e}if(n.existsSync(l)){var u={input:n.readFileSync(l).toString(),rerouteLinks:t=>o.join(e.rootPermalink,t)};s&&(u.citations=s);var f=d.markademic(u);r.push(f)}}return y({},e,{data:{toc:t,chapters:r}})}}];function O(e,t){return Object.keys(e.test).reduce((o,n)=>{let r=new RegExp(e.test[n]);return o||r.test(t[n])},!1)}async function C(e,t){for(let o of e)if(O(o,t))try{t=await o.transform(t)}catch(e){console.error(e)}return t}var T,_=[async function(t){console.log("🌊 Foil Database Cleaner:"),await k.then(async t=>{let r=t.db("db");var i=r.collection("redirect"),a=r.collection("portfolio"),l=e=>e.find({}).toArray().catch(e=>console.error(e)).then(t=>{if(t)for(var r of t){let{_id:t,permalink:i=null}=r,a=r.to?[{path:r.to}]:r.meta.files;for(let r of a){let a=()=>{e.deleteOne({_id:t}).catch(e=>console.error(e)).then(()=>console.log("❌ Removed "+r.path))};/\.([A-z])*$/.test(r.path)&&n.stat(r.path,e=>{if("ENOENT"===(null==e?void 0:e.code)&&a(),e&&"package.json"==o.basename(r.path)&&i){let e=require(r.path);e.foil&&"/"+e.foil.permalink!==i&&(console.log("Permalink "+i+" does not match "+e.foil.permalink+", deleting."),a())}})}}});await l(i),console.log(`🧼 Cleaned ${e.cyan("'files'")} collection.`),await l(a),console.log(`🧼 Cleaned ${e.cyan("'portfolio'")} collection.`)})},async function(t){for(var o of(console.log("📦 Foil Database Builder:"),t))if(o){console.log("⚪ Processing "+e.yellow(`'${o.permalink}'`)+":");let t=await C(q,o);await S(t)}},async function(e){console.log("📻 Foil RSS Feeds \n");const t=new m.Feed({title:w.title,description:w.description,id:w.author.url,link:w.author.url,language:"en",image:w.cover,favicon:w.author.url+"/assets/brand/favicon/favicon.ico",copyright:"Copyright "+w.author.name+" All Rights Reserved.",updated:new Date,generator:"Feed in Foil",feedLinks:{rss:w.author.url+"/rss",json:w.author.url+"/feedJson",atom:w.author.url+"/feedAtom"},author:{name:w.author.name,email:w.author.email,link:w.author.url},ttl:1200});for(let e of w.tags)t.addCategory(e);let r=await new Promise((e,t)=>k.then(t=>{t.db("db").collection("portfolio").find({datePublished:{$lte:new Date},permalink:new RegExp("/blog/w*")}).limit(30).sort({datePublished:-1}).toArray((t,o)=>{if(t||0===o.length)return e([]);e(o)})}));for(var i of r){let e=await new Promise((e,t)=>k.then(t=>{t.db("db").collection("redirect").find({from:i.cover}).limit(1).toArray((t,o)=>{if(t||0===o.length)return e(null);e(o)})}));var a=0;e&&(a=n.statSync(e[0].to).size),t.addItem({title:i.title,id:w.author.url+i.permalink,link:w.author.url+i.permalink,description:i.description,author:[{name:"Jane Doe",email:"janedoe@example.com",link:"https://example.com/janedoe"},{name:"Joe Smith",email:"joesmith@example.com",link:"https://example.com/joesmith"}],contributor:[{name:"Shawn Kemp",email:"shawnkemp@example.com",link:"https://example.com/shawnkemp"},{name:"Reggie Miller",email:"reggiemiller@example.com",link:"https://example.com/reggiemiller"}],date:i.datePublished,image:{url:w.author.url+i.cover,length:a}})}let l=t.rss2(),s=o.join(w.currentDir,"rss.xml");try{n.writeFileSync(s,l),console.log("RSS feed successfully generated. \n Written to "+s+"\n")}catch(e){console.error("Could not generate RSS Feeds! \n")}},async function(e){console.log("🏹 Foil Database Redirects\n"),await k.then(async e=>{var t=e.db("db").collection("redirect"),o=w.redirects;for(var n of o)if(n.to&&n.from){let e={from:n.from},o={upsert:!0};await t.updateOne(e,{$set:{to:n.to,from:n.from}},o).then(e=>console.log(`Redirecting ${n.from} to ${n.to}.`)).catch(e=>console.log(e))}console.log("✨ Cleaned portfolio collection.")})}];class R{async run(t){for(var o=Object.values(_),n=0;n<o.length;n++){let r=`(${n+1}/${o.length})`;console.log(`\n👟 ${e.gray(` Running Task ${r}...`)}`),await o[n](t).then(t=>{console.log(`✔️️ ${e.green(` Finished Task ${r}!`)}`)}).catch(t=>{console.log(`\n❌ ${e.red(` Failed Task ${r}!`)}`),console.error(t)})}console.log("\n💮 "+e.gray(` Finished processing ${o.length} tasks!\n`))}}!function(e){e[e.Initial=0]="Initial",e[e.Watching=1]="Watching",e[e.Processing=2]="Processing",e[e.Done=3]="Done"}(T||(T={}));class M{constructor(){this.watch=async t=>{let o=T.Initial;const n=new R;let r=[];const i=async()=>{switch(+o){case T.Initial:t.length>0&&await n.run(t),console.log(e.gray("\n👀  · Watching for changes... · \n")),o=T.Watching;break;case T.Watching:r=await P(),r.length>0&&(o=T.Processing);break;case T.Processing:r.length>0&&await n.run(r),o=T.Done;break;case T.Done:console.log(e.gray("\n👀  · Watching for changes... · \n")),o=T.Watching}await i()};await i()}}}async function I(){console.log("👋 Hi "+w.author.name+"!");let t=await P();if(t.length>0&&console.log(e.gray("🎡 Processing "+t.length+" files.")),p){const e=new M;await e.watch(t)}else if(t.length>0){const e=new R;await e.run(t)}else console.log(e.gray("👍 No changes found, exiting."));return process.exit()}console.log(e.cyan("✨ Foil v1.0.0-alpha.0")+e.gray(h?" (production)":" (development)")),I(),exports.foil=I;
//# sourceMappingURL=foil-cli.js.map
